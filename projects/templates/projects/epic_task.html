<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ project.name }} - TaskFlow</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#1e40af',
            accent: '#06b6d4',
            dark: '#1f2937',
            'dark-light': '#374151'
          }
        }
      }
    }
  </script>
  <style>
    body {
      background-image: url('https://images.unsplash.com/photo-1490750967868-88aa4486c946?w=1920&q=80');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="flex h-screen">
     <div id="sidebar" class="text-white w-64 min-h-screen p-4 transition-transform duration-300 ease-in-out fixed lg:relative z-50 -translate-x-full lg:translate-x-0 bg-gradient-to-b from-blue-600/25 to-purple-600/25 backdrop-blur-xl border-r border-white/20">
      <div class="flex items-center mb-8">
        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center mr-3 shadow-lg">
          <i class="fas fa-tasks text-white"></i>
        </div>
        <h1 class="text-xl font-bold">Adminto</h1>
      </div>
      
      <div class="mb-8">
        <div class="flex items-center mb-4">
          <img src="public/thoughtful-man.png" alt="User" class="w-10 h-10 rounded-full mr-3 border-2 border-white/30">
          <div>
            <p><span class="font-semibold">Name:</span> {{ request.user.username }}</p>
            <p><span class="font-semibold">Role:</span> {{ request.user.profile.role }}</p>

          </div>
        </div>
      </div>
      
      <nav class="space-y-2">
        <a href="dashboard.html" class="flex items-center px-4 py-3 text-white/80 hover:text-white hover:bg-white/10 rounded-lg transition-all">
          <i class="fas fa-tachometer-alt mr-3"></i>
          Dashboard
        </a>
        <a href="{% url 'projects:clients' %}" class="flex items-center px-4 py-3 text-white/80 hover:text-white hover:bg-white/10 rounded-lg transition-all">
          <i class="fas fa-tasks mr-3"></i>
          Clients
        </a>
        <a href="{% url 'projects:projects' %}" class="flex items-center px-4 py-3 text-white bg-blue-500/40 rounded-lg shadow-lg backdrop-blur-sm">
          <i class="fas fa-project-diagram mr-3"></i>
          Projects
        </a>
        <a href="calendar.html" class="flex items-center px-4 py-3 text-white/80 hover:text-white hover:bg-white/10 rounded-lg transition-all">
          <i class="fas fa-calendar mr-3"></i>
          Calendar
        </a>
        <a href="#" class="flex items-center px-4 py-3 text-white/80 hover:text-white hover:bg-white/10 rounded-lg transition-all">
          <i class="fas fa-users mr-3"></i>
          Users
        </a>
        <a href="#" class="flex items-center px-4 py-3 text-white/80 hover:text-white hover:bg-white/10 rounded-lg transition-all">
          <i class="fas fa-envelope mr-3"></i>
          Email
        </a>
      </nav>
    </div>
    
     <div class="flex-1 flex flex-col overflow-hidden lg:ml-0">
       <header class="bg-white/80 backdrop-blur-xl shadow-sm border-b border-white/20 px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <button id="sidebar-toggle" class="text-gray-500 hover:text-gray-700 mr-4 lg:hidden transition-colors">
              <i class="fas fa-bars text-xl"></i>
            </button>
            <h1 class="text-2xl font-semibold text-gray-900">{{ project.name }}</h1>
          </div>
          <div class="flex items-center space-x-4">
            <div class="relative hidden md:block">
              <input type="text" placeholder="Search projects..." class="bg-white/60 backdrop-blur-sm border border-white/40 rounded-lg px-4 py-2 pl-10 focus:outline-none focus:ring-2 focus:ring-blue-500">
              <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
            <button class="text-gray-500 hover:text-gray-700 transition-colors">
              <i class="fas fa-bell text-xl"></i>
            </button>
            <div class="flex items-center">
              <img src="public/thoughtful-man.png" alt="User" class="w-8 h-8 rounded-full border-2 border-blue-500/30">
              <span class="ml-2 text-sm font-medium text-gray-700 hidden md:inline">{{ request.user.username }}</span>
            </div>
          </div>
        </div>
      </header>
      
       <main class="flex-1 overflow-x-hidden overflow-y-auto p-6">
        
         <div class="bg-white rounded-xl shadow-xl p-6 mb-8 border border-gray-200">
          <h2 class="text-2xl font-bold text-gray-800 mb-2">🚀 {{ project.name }}</h2>
          <p class="text-gray-600 mb-4">{{ project.description }}</p>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
            <p><span class="font-semibold text-gray-700">Start Date:</span> {{ project.start_date|date:"d M Y" }}</p>
            <p><span class="font-semibold text-gray-700">End Date:</span> {{ project.end_date|date:"d M Y" }}</p>
            <p><span class="font-semibold text-gray-700">Status:</span>
              {% if project.status == "Active" %}
              <span class="text-green-600 font-semibold">{{ project.status }}</span>
              {% elif project.status == "Completed" %}
              <span class="text-blue-600 font-semibold">{{ project.status }}</span>
              {% else %}
              <span class="text-yellow-600 font-semibold">{{ project.status }}</span>
              {% endif %}
            </p>
            <p><span class="font-semibold text-gray-700">Members:</span>
              {% for member in project.team_members.all %}
              {{ member.user.username }}{% if not forloop.last %}, {% endif %}
              {% empty %}
              <span class="text-gray-400">No members</span>
              {% endfor %}
            </p>
          </div>
        </div>

        <!-- Epics Grid -->
        <!-- Epics Grid -->
        <div>
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-gray-800">📌 Epic Tasks</h3>
            <!-- Toggle Epic Form Button -->
            <button id="toggleEpicFormBtn"
              class="px-3 py-1 bg-primary text-white rounded-lg hover:bg-secondary text-sm">
              + Add Epic
            </button>
          </div>

          <!-- Add Epic Form (Initially Hidden) -->
          <div id="addEpicFormContainer" class="hidden bg-gray-50 p-4 rounded-lg border mb-6">
            <form method="POST" action="{% url 'projects:epic_create' project.id %}">
              {% csrf_token %}
              <input type="text" name="title" placeholder="Epic Title" class="w-full border rounded-lg p-2 mb-2"
                required>
              <textarea name="description" placeholder="Epic Description"
                class="w-full border rounded-lg p-2 mb-2"></textarea>

              <div class="grid grid-cols-2 gap-2 mb-2">
                <input type="date" name="deadline" class="w-full border rounded-lg p-2">
                <select name="priority" class="w-full border rounded-lg p-2">
                  <option value="low">Low</option>
                  <option value="medium">Medium</option>
                  <option value="high">High</option>
                </select>
              </div>
              <div class="mb-2">
                <select name="status" class="w-full border rounded-lg p-2">
                  <option value="pending">Pending</option>
                  <option value="in_progress">In Progress</option>
                  <option value="completed">Completed</option>
                </select>
              </div>
              <label class="block mb-1 text-sm font-medium text-gray-700">Assign Users</label>
              <select name="assigned_users" multiple class="w-full border rounded-lg p-2 mb-3">
                {% for profile in project.team_members.all %}
                <option value="{{ profile.id }}">{{ profile.user.username }}</option>
                {% endfor %}
              </select>

              <div class="flex justify-end gap-2">
                <button type="button" id="cancelEpicFormBtn"
                  class="px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit" class="px-3 py-1 bg-primary text-white rounded-lg hover:bg-secondary">Save
                  Epic</button>
              </div>
            </form>
          </div>

          <div class="space-y-6">
            {% for epic in epics %}
            <div class="bg-white rounded-xl shadow p-5 hover:shadow-lg transition w-full id=" epic-{{ epic.id }}">
              <!-- ✅ Clickable title for sidebar -->
               <input type="checkbox"
       class="epic-checkbox toggleEpicCompletion"
       data-epic-id="{{ epic.id }}"
       {% if epic.status == "completed" %}checked disabled{% endif %}>

              <h4 class="text-lg font-bold text-primary mb-2 cursor-pointer epic-title"  data-id="{{ epic.id }}" data-title="{{ epic.title }}"  
              data-description="{{ epic.description }}" data-deadline="{{ epic.deadline|date:'d M Y' }}"
                data-priority="{{ epic.priority }}" data-status="{{ epic.status }}"
                data-assigned="{% for profile in epic.assigned_users.all %}{{ profile.user.username }}{% if not forloop.last %},{% endif %}{% endfor %}">
                {{ epic.title }}
              </h4>
              <p class="text-gray-600 text-sm mb-3">{{ epic.description }}</p>
              <div class="flex justify-between text-sm text-gray-700 mb-2">
                <p><span class="font-semibold">Deadline:</span> {{ epic.deadline|date:"d M Y" }}</p>
                <p><span class="font-semibold">Priority:</span> {{ epic.priority }}</p>
              </div>
              <div class="mb-2">
                <span class="font-semibold">Assigned:</span>
                {% for profile in epic.assigned_users.all %}
                <span class="inline-block bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded-full mr-1">
                  {{ profile.user.username }}
                </span>
                {% empty %}
                <span class="text-gray-400">Unassigned</span>
                {% endfor %}
              </div>
              <p class="text-sm mb-2"><span class="font-semibold">Status:</span>
                {% if epic.status == "In Progress" %}
                <span class="text-yellow-600 font-semibold">{{ epic.status }}</span>
                {% elif epic.status == "Completed" %}
                <span class="text-green-600 font-semibold">{{ epic.status }}</span>
                {% else %}
                <span class="text-gray-600 font-semibold">{{ epic.status }}</span>
                {% endif %}
              </p>

              <!-- Buttons -->
              <div class="flex gap-2 mb-2">
                <button class="px-3 py-1 text-sm bg-accent text-white rounded-lg hover:bg-secondary toggleTaskFormBtn"
                  data-epic="{{ epic.id }}">
                  + Add Task
                </button>
                <button class="px-3 py-1 text-sm bg-primary text-white rounded-lg hover:bg-secondary toggleTaskListBtn"
                  data-epic="{{ epic.id }}">
                  Show Tasks
                </button>
              </div>

              <!-- Task Form -->
              <div class="taskFormContainer hidden mt-3 bg-gray-50 p-3 rounded-lg border" id="taskForm-{{ epic.id }}">
                <form method="POST" action="{% url 'projects:task_create' epic.id %}">
                  {% csrf_token %}
                  <input type="text" name="title" placeholder="Task Title" class="w-full border rounded-lg p-2 mb-2"
                    required>
                  <textarea name="description" placeholder="Task Description"
                    class="w-full border rounded-lg p-2 mb-2"></textarea>

                  <div class="grid grid-cols-2 gap-2 mb-2">
<div class="grid grid-cols-2 gap-2 mb-2">
  <input type="datetime-local" name="start_time" class="w-full border rounded-lg p-2" placeholder="Start Time">
  <input type="datetime-local" name="end_time" class="w-full border rounded-lg p-2" placeholder="End Time">
</div>

                    <select name="priority" class="w-full border rounded-lg p-2">
                      <option value="low">Low</option>
                      <option value="medium" selected>Medium</option>
                      <option value="high">High</option>
                    </select>
                  </div>

                  <div class="grid grid-cols-2 gap-2 mb-2">
                    <select name="status" class="w-full border rounded-lg p-2">
                      <option value="pending">Pending</option>
                      <option value="in_progress">In Progress</option>
                      <option value="completed">Completed</option>
                    </select>
                    <select name="assigned_users" multiple class="w-full border rounded-lg p-2">
                      {% for profile in profiles %}
                      <option value="{{ profile.id }}">{{ profile.user.username }}</option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="flex justify-end gap-2">
                    <button type="button" class="cancelTaskFormBtn px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300"
                      data-epic="{{ epic.id }}">Cancel</button>
                    <button type="submit"
                      class="px-3 py-1 bg-primary text-white rounded-lg hover:bg-secondary">Save</button>
                  </div>
                </form>
              </div>

              <!-- Task List -->
              <div class="mt-3 space-y-2 hidden taskListContainer" id="taskList-{{ epic.id }}">
                {% for task in epic.tasks.all %}
               <div class="task-item border rounded-lg p-3 bg-gray-50 hover:bg-gray-100 transition w-full" id="task-{{ task.id }}">

<input type="checkbox"
       class="task-checkbox toggleTaskCompletion"
       data-task-id="{{ task.id }}"
       {% if task.status == "completed" %}checked disabled{% endif %}>

                  <!-- ✅ Clickable title for sidebar -->
                  <p class="font-semibold cursor-pointer task-title"  data-id="{{ task.id }}" data-title="{{ task.title }}"
                    data-description="{{ task.description }}" data-deadline="{{ task.deadline|date:'d M Y' }}"
                    data-priority="{{ task.get_priority_display }}" data-status="{{ task.get_status_display }}"
                    data-assigned="{% for user in task.assigned_users.all %}{{ user.user.username }}{% if not forloop.last %},{% endif %}{% endfor %}">
                    {{ task.title }}
                  </p>

                  <p class="text-gray-600 text-sm">{{ task.description }}</p>
                  <p class="text-xs text-gray-500 flex items-center gap-2">
 <i class="fas fa-clock text-gray-400"></i> Estimated: {{ task.estimated_time_display }}

                    <span class="mx-1">|</span>
                    <i class="fas fa-tasks text-gray-400"></i> Status: {{ task.get_status_display }}
                    <span class="mx-1">|</span>
                    <i class="fas fa-flag text-gray-400"></i> Priority: {{ task.get_priority_display }}
                  </p>

                  {% if task.assigned_users.exists %}
                  <p class="text-xs text-gray-700 mt-1 flex items-center gap-2">
                    <i class="fas fa-users text-gray-400"></i>
                    <span class="font-medium">Assigned to:</span>
                    {% for user in task.assigned_users.all %}
                    <span class="inline-block bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded-full">
                      {{ user.user.username }}
                    </span>
                    {% endfor %}
                  </p>
                  {% else %}
                  <p class="text-xs text-gray-400 mt-1 italic flex items-center gap-2">
                    <i class="fas fa-user-slash text-gray-400"></i> No users assigned
                  </p>
                  {% endif %}

                  <!-- SubTasks -->
                  <button class="mt-2 px-2 py-1 text-xs bg-accent text-white rounded-lg toggleSubTaskBtn"
                    data-task="{{ task.id }}">
                    <i class="fas fa-list mr-1"></i> Show SubTasks
                  </button>

                  <!-- SubTask List -->
<div class="mt-2 hidden subTaskContainer" id="subTask-{{ task.id }}">
  {% for subtask in task.subtasks.all %}
  <div
    class="subtask-item border p-2 rounded bg-white hover:bg-gray-50 flex items-center justify-between gap-4"
    id="subtask-{{ subtask.id }}"
    data-title="{{ subtask.title }}"
    data-description="{{ subtask.description }}"
    data-start="{{ subtask.start_datetime|date:'d M Y H:i' }}"
    data-end="{{ subtask.end_datetime|date:'d M Y H:i' }}"
    data-status="{% if subtask.status == 'completed' %}Completed{% else %}Pending{% endif %}"
    data-subtask-id="{{ subtask.id }}"
    data-assigned="{% for user in subtask.assigned_users.all %}{{ user.user.username }}{% if not forloop.last %},{% endif %}{% endfor %}">

    <!-- Left Side: Checkbox, title, users -->
    <div class="flex-1">
      <div class="flex items-center gap-2 text-sm">
        <input type="checkbox" class="subtask-checkbox toggleSubTaskCompletion"
          data-subtask-id="{{ subtask.id }}" {% if subtask.status == "completed" %}checked disabled{% endif %}>

        <span class="subtask-title"
          data-id="{{ subtask.id }}"
          data-title="{{ subtask.title }}"
          data-description="{{ subtask.description }}"
          data-start="{{ subtask.start_datetime }}"
          data-end="{{ subtask.end_datetime }}"
          data-priority="{{ subtask.priority }}"
          data-status="{{ subtask.status }}"
          data-assigned="{% for u in subtask.assigned_users.all %}{{ u }}{% if not forloop.last %}, {% endif %}{% endfor %}"
          data-time_estimated="{{ subtask.estimated_time_display|default:'1d' }}"
          data-time_tracked="{{ subtask.time_tracked }}">
          {{ subtask.title }}
        </span>

        <!-- ✅ add this so JS can update status instantly -->
        <span class="subtask-status text-gray-500" data-id="{{ subtask.id }}">
          {{ subtask.status }}
        </span>
      </div>

      {% if subtask.assigned_users.exists %}
      <div class="ml-6 flex flex-wrap gap-1 mt-1">
        {% for user in subtask.assigned_users.all %}
        <span class="inline-block bg-green-100 text-green-700 text-xs px-2 py-0.5 rounded-full">
          {{ user.user.username }}
        </span>
        {% endfor %}
      </div>
      {% else %}
      <p class="ml-6 text-xs text-gray-400 italic flex items-center gap-1">
        <i class="fas fa-user-slash text-gray-300"></i> No users assigned
      </p>
      {% endif %}
    </div>

    <div class="mt-2 ml-6 w-[20%]">
      <div
        class="h-2 bg-gray-200 rounded-full overflow-hidden relative progress-bar-container"
        data-subtask-id="{{ subtask.id }}"
        data-estimated="{{ subtask.estimated_time }}"
        data-tracked="{{ subtask.time_tracked }}"
      >
        <div class="h-2 bg-green-500 progress-bar-fill absolute left-0 top-0 transition-all duration-500 ease-out"></div>
        <div class="h-2 bg-red-500 progress-bar-overdue absolute left-0 top-0 transition-all duration-500 ease-out"></div>
      </div>

      <div class="text-xs text-gray-500 mt-1 time-info">
        {{ subtask.time_tracked_display }} tracked / {{ subtask.estimated_time_display }} estimated
      </div>
    </div>
  </div>
  {% empty %}
  <p class="text-gray-400 text-xs">No SubTasks</p>
  {% endfor %}

  <!-- Add SubTask Button & Form -->
  <div class="mt-2">
    <button class="px-2 py-1 text-xs bg-primary text-white rounded-lg toggleAddSubTaskBtn"
      data-task="{{ task.id }}">
      <i class="fas fa-plus mr-1"></i> Add SubTask
    </button>

    <div class="mt-2 hidden addSubTaskFormContainer" id="addSubTaskForm-{{ task.id }}">
      <form method="POST" action="{% url 'projects:subtask_create' task.id %}">
        {% csrf_token %}
        <input type="hidden" name="status" value="pending">

        <input type="text" name="title" placeholder="SubTask Title"
          class="w-full border rounded-lg p-2 mb-2" required>

        <textarea name="description" placeholder="SubTask Description"
          class="w-full border rounded-lg p-2 mb-2"></textarea>

        <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
        <select name="priority" class="w-full border rounded-lg p-2 mb-3">
          <option value="low">Low</option>
          <option value="medium" selected>Medium</option>
          <option value="high">High</option>
        </select>

        <!-- ✅ Replaced old deadline fields -->
        <label class="block text-sm font-medium text-gray-700 mb-1">Start Date & Time</label>
        <input type="datetime-local" name="start_datetime" class="w-full border rounded-lg p-2 mb-3">

        <label class="block text-sm font-medium text-gray-700 mb-1">End Date & Time</label>
        <input type="datetime-local" name="end_datetime" class="w-full border rounded-lg p-2 mb-3">

        <!-- ✅ Removed old "Deadline" field completely -->

        <label class="block text-sm font-medium text-gray-700 mb-1">Assign Users</label>
        <select name="assigned_users" multiple
          class="w-full border rounded-lg p-2 mb-3 form-multiselect">
          {% for profile in profiles %}
          <option value="{{ profile.id }}">{{ profile.user.username }}</option>
          {% endfor %}
        </select>

        <div class="flex justify-end gap-2">
          <button type="button"
            class="cancelSubTaskFormBtn px-2 py-1 bg-gray-200 rounded-lg hover:bg-gray-300"
            data-task="{{ task.id }}">Cancel</button>
          <button type="submit"
            class="px-2 py-1 bg-primary text-white rounded-lg hover:bg-secondary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>




                </div>
                {% empty %}
                <p class="text-gray-400 text-sm">No tasks yet</p>
                {% endfor %}
              </div>




            </div>
            {% empty %}
            <p class="text-gray-500">No epics found for this project.</p>
            {% endfor %}
          </div>
        </div>

      </main>
    </div>

  </div>

  </main>
  </div>
  </div>
<div id="timeTrackModal"
                      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                      <div class="bg-white rounded-lg shadow-lg w-96 p-6">
                        <h2 class="text-lg font-semibold mb-4">Track Time</h2>
                        <form id="timeTrackForm" method="POST" action="">
                          {% csrf_token %}
                          <input type="hidden" name="subtask_id" id="timeTrackSubTaskId">

                          <label class="block text-sm font-medium text-gray-700 mb-1">Time Spent (hours)</label>
                          <input type="text" name="time_tracked" id="timeTrackedInput"
       class="w-full border rounded-lg p-2 mb-4"
       placeholder="Enter: 1.5 | 1:30 | 1:30pm | 1d 3h | 1.5d" required>
<div id="formattedTimeDisplay" class="text-sm text-gray-500 mt-1"></div>


                          <div class="flex justify-end gap-2">
                            <button type="button" id="cancelTimeTrack"
                              class="px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                            <button type="submit"
                              class="px-3 py-1 bg-primary text-white rounded-lg hover:bg-secondary">Save</button>
                          </div>
                        </form>
                      </div>
                    </div>
  <script>
    // Toggle Epic Form
    const toggleEpicBtn = document.getElementById('toggleEpicFormBtn');
    const addEpicForm = document.getElementById('addEpicFormContainer');
    const cancelEpicBtn = document.getElementById('cancelEpicFormBtn');
    toggleEpicBtn.addEventListener('click', () => addEpicForm.classList.toggle('hidden'));
    cancelEpicBtn.addEventListener('click', () => addEpicForm.classList.add('hidden'));

    // Toggle Task Form
    document.querySelectorAll(".toggleTaskFormBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const epicId = btn.dataset.epic;
        document.getElementById(`taskForm-${epicId}`).classList.toggle("hidden");
      });
    });
    document.querySelectorAll(".cancelTaskFormBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const epicId = btn.dataset.epic;
        document.getElementById(`taskForm-${epicId}`).classList.add("hidden");
      });
    });

    // Toggle Task List
    document.querySelectorAll(".toggleTaskListBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const epicId = btn.dataset.epic;
        const taskList = document.getElementById(`taskList-${epicId}`);
        taskList.classList.toggle("hidden");
        btn.textContent = taskList.classList.contains("hidden") ? "Show Tasks" : "Hide Tasks";
      });
    });

    // Toggle SubTask List
    document.querySelectorAll(".toggleSubTaskBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const taskId = btn.dataset.task;
        const subTaskList = document.getElementById(`subTask-${taskId}`);
        subTaskList.classList.toggle("hidden");
        btn.textContent = subTaskList.classList.contains("hidden") ? "Show SubTasks" : "Hide SubTasks";
      });
    });

    // Toggle Add SubTask Form
    document.querySelectorAll(".toggleAddSubTaskBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const taskId = btn.dataset.task;
        document.getElementById(`addSubTaskForm-${taskId}`).classList.toggle("hidden");
      });
    });

    // Cancel SubTask Form
    document.querySelectorAll(".cancelSubTaskFormBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const taskId = btn.dataset.task;
        document.getElementById(`addSubTaskForm-${taskId}`).classList.add("hidden");
      });
    });
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      document.querySelectorAll(".toggleSubTaskCompletion").forEach(checkbox => {
        checkbox.addEventListener("click", function (e) {
          const subtaskId = this.dataset.subtaskId;

          // Only act if not already completed
          if (!this.checked) return e.preventDefault();

          fetch(`/projects/subtask/${subtaskId}/toggle/`, {
            method: "POST",
            headers: {
              "X-CSRFToken": csrftoken,
              "Content-Type": "application/json",
            },
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                this.disabled = true; // lock it
                this.nextElementSibling.classList.add("line-through", "text-gray-400");
              } else {
                this.checked = false; // rollback
              }
            })
            .catch(() => { this.checked = false; });
        });
      });
    });
  </script>

  <!-- ✅ Task Sidebar (drawer) -->
  <div id="taskSidebar"
    class="fixed top-0 right-0 w-96 h-full bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50">

    <div class="flex justify-between items-center p-4 border-b">
      <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
        <i class="fas fa-tasks text-primary"></i> Task Details
      </h3>
      <button id="closeSidebar" class="text-gray-500 hover:text-gray-700">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="p-4 space-y-4 text-sm text-gray-700">

      <!-- Title -->
      <p class="flex items-center gap-2">
        <i class="fas fa-heading text-blue-500"></i>
        <span class="font-semibold">Title:</span> <span id="sidebarTitle"></span>
      </p>

      <!-- Description -->
      <p class="flex items-start gap-2">
        <i class="fas fa-align-left text-green-500 mt-0.5"></i>
        <span class="font-semibold">Description:</span>
        <span id="sidebarDescription" class="flex-1"></span>
      </p>

      <!-- Deadline -->
      <p class="flex items-center gap-2">
        <i class="fas fa-calendar-alt text-red-500"></i>
        <span class="font-semibold">Deadline:</span> <span id="sidebarDeadline"></span>
      </p>

      <!-- Priority -->
      <p class="flex items-center gap-2">
        <i class="fas fa-flag text-yellow-500"></i>
        <span class="font-semibold">Priority:</span> <span id="sidebarPriority"></span>
      </p>

      <!-- Status -->
      <p class="flex items-center gap-2">
        <i class="fas fa-info-circle text-purple-500"></i>
        <span class="font-semibold">Status:</span> <span id="sidebarStatus"></span>
      </p>

      <!-- Assigned Users -->
      <div class="flex items-start gap-2">
        <i class="fas fa-users text-indigo-500 mt-0.5"></i>
        <div>
          <span class="font-semibold">Assigned:</span>
          <div id="sidebarAssigned" class="mt-1 flex flex-wrap gap-1"></div>
        </div>
      </div>

      <!-- ✅ Time Estimated -->
      <p class="flex items-center gap-2">
  <i class="fas fa-clock text-orange-500"></i>
  <span class="font-semibold">Time Estimated:</span>
  <span id="sidebarEstimated">—</span>
</p>


      <!-- ✅ Subtask Time Tracked -->
      <p class="flex items-center gap-2">
        <i class="fas fa-stopwatch text-teal-500"></i>
        <span class="font-semibold">Time Track:</span>
        <span id="sidebarTimeTracked">0</span>
      </p>

      

    </div>
</div>



  <!-- Overlay -->
  <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-40 hidden z-40"></div>

 <script>
document.addEventListener("DOMContentLoaded", () => {
  // ---------- New helpers: parse & format ------------

  // parse many formats into decimal hours (Number)
  function parseTimeInputToHours(raw) {
    if (raw === null || raw === undefined) return 0;
    let s = String(raw).trim().toLowerCase();
    if (s === "") return 0;

    // 1) days/hours/minutes tokens like "1d 2h 10m" or "2h 10m" or "90m"
    const dMatch = /(\d+(\.\d+)?)\s*d/.exec(s);
    const hMatch = /(\d+(\.\d+)?)\s*h/.exec(s);
    const mMatch = /(\d+)\s*m/.exec(s);

    if (dMatch || hMatch || mMatch) {
      const days = dMatch ? parseFloat(dMatch[1]) : 0;
      const hours = hMatch ? parseFloat(hMatch[1]) : 0;
      const mins = mMatch ? parseInt(mMatch[1], 10) : 0;
      const total = days * 24 + hours + mins / 60;
      return Number(total.toFixed(2));
    }

    // 2) H:MM or H.MM optionally with am/pm (we interpret H:MM as duration; am/pm can be converted to a 24h number)
    const colon = /^(\d{1,2})[:\.](\d{1,2})(?:\s*(am|pm))?$/.exec(s);
    if (colon) {
      let h = parseInt(colon[1], 10);
      const min = parseInt(colon[2], 10);
      const ampm = colon[3];
      if (ampm) {
        // treat as clock time -> convert to hours since midnight
        if (ampm === "pm" && h !== 12) h += 12;
        if (ampm === "am" && h === 12) h = 0;
        return Number((h + min / 60).toFixed(2));
      }
      // interpret as duration H:MM
      return Number((h + min / 60).toFixed(2));
    }

    // 3) minutes only like "90m"
    const onlyMinutes = /^(\d+)\s*m$/.exec(s);
    if (onlyMinutes) {
      const mins = parseInt(onlyMinutes[1], 10);
      return Number((mins / 60).toFixed(2));
    }

    // 4) decimal days like "1.5d"
    const decimalDays = /^(\d+(\.\d+)?)\s*d$/.exec(s);
    if (decimalDays) {
      return Number((parseFloat(decimalDays[1]) * 24).toFixed(2));
    }

    // 5) decimal hours like "1.5h" or plain number "1.5"
    const decimalHours = /^(\d+(\.\d+)?)\s*h$/.exec(s) || /^(\d+(\.\d+)?)$/.exec(s);
    if (decimalHours) {
      return Number(parseFloat(decimalHours[1]).toFixed(2));
    }

    // fallback
    const n = parseFloat(s);
    return isNaN(n) ? null : Number(n.toFixed(2));
  }

  // format a decimal-hours number into "Xd Yh Zm" (or "Today" if zero)
  function formatHoursToDHM(hours) {
    const h = Number(hours) || 0;
    const totalMinutes = Math.round(h * 60);
    if (totalMinutes === 0) return "Today";

    const days = Math.floor(totalMinutes / (24 * 60));
    let rem = totalMinutes % (24 * 60);
    const hrs = Math.floor(rem / 60);
    const mins = rem % 60;

    const parts = [];
    if (days) parts.push(`${days}d`);
    if (hrs) parts.push(`${hrs}h`);
    if (mins) parts.push(`${mins}m`);
    return parts.join(" ");
  }

 // ---------- Progress bar helper (updated: green + red logic) ----------
function updateSubtaskBarsForContainer(container) {
  if (!container) return;

  const estimated = parseFloat(container.dataset.estimated || 0);
  const tracked = parseFloat(container.dataset.tracked || 0);
  const greenFill = container.querySelector(".progress-bar-fill");
  const redFill = container.querySelector(".progress-bar-overdue");

  if (!greenFill || !redFill) return;

  // Reset widths
  greenFill.style.width = "0%";
  redFill.style.width = "0%";

  if (estimated <= 0) return;

  const ratio = tracked / estimated;
  const greenPercent = Math.min(ratio * 100, 100);
  const redPercent = ratio > 1 ? (ratio - 1) * 100 : 0;

  // Apply widths
  greenFill.style.width = `${greenPercent}%`;
  redFill.style.left = `${greenPercent}%`;
  redFill.style.width = `${redPercent}%`;

  // Optional: smooth transition colors
  greenFill.classList.remove("bg-red-500");
  greenFill.classList.add("bg-green-500");
  redFill.classList.add("bg-red-500");
}

// ---------- Initialize all bars & text on load ----------
document.querySelectorAll(".progress-bar-container").forEach(container => {
  updateSubtaskBarsForContainer(container);
  try {
    const row = container.closest("[id^='subtask-']");
    if (row) {
      const info = row.querySelector(".time-info");
      if (info) {
        const tracked = parseFloat(container.dataset.tracked || 0);
        const est = parseFloat(container.dataset.estimated || 0);
        info.textContent = `${formatHoursToDHM(tracked)} tracked / ${formatHoursToDHM(est)} estimated`;
      }
    }
  } catch (e) { /* ignore */ }
});

  // ---------- Modal elements ----------
  const modal = document.getElementById("timeTrackModal");
  const form = document.getElementById("timeTrackForm");
  const cancelBtn = document.getElementById("cancelTimeTrack");
  const input = document.getElementById("timeTrackedInput");
  const modalSubtaskId = document.getElementById("timeTrackSubTaskId");
  const formattedTimeDisplay = document.getElementById("formattedTimeDisplay");

  // live preview on input (shows "1d 1h 10m")
  if (input) {
    input.addEventListener("input", () => {
      const parsed = parseTimeInputToHours(input.value);
      if (parsed === null) {
        if (formattedTimeDisplay) formattedTimeDisplay.textContent = "Invalid format";
      } else {
        if (formattedTimeDisplay) formattedTimeDisplay.textContent = formatHoursToDHM(parsed);
      }
    });
  }

  // Open modal when subtask checkbox changed (existing code kept)
  document.querySelectorAll(".toggleSubTaskCompletion").forEach(checkbox => {
    checkbox.addEventListener("change", function (e) {
      e.stopPropagation();
      if (this.checked && !this.disabled) {
        this.checked = true;
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        modalSubtaskId.value = this.dataset.subtaskId;
        // prefill input preview with current tracked value
        const subtaskRow = document.getElementById(`subtask-${this.dataset.subtaskId}`);
        if (subtaskRow) {
          const bar = subtaskRow.querySelector(".progress-bar-container");
          if (bar && input) {
            input.value = ''; // keep empty to encourage new entry (we add instead of overwrite)
            if (formattedTimeDisplay) {
              const tracked = parseFloat(bar.dataset.tracked || 0);
              formattedTimeDisplay.textContent = formatHoursToDHM(tracked);
            }
          }
        }
      } else {
        this.checked = true;
      }
    });
    checkbox.addEventListener("click", e => e.stopPropagation());
  });

  cancelBtn.addEventListener("click", () => {
    modal.classList.add("hidden");
    modal.classList.remove("flex");
    input.value = "";
    if (formattedTimeDisplay) formattedTimeDisplay.textContent = "";
    const subtaskId = modalSubtaskId.value;
    const checkbox = document.querySelector(`.toggleSubTaskCompletion[data-subtask-id="${subtaskId}"]`);
    if (checkbox && !checkbox.disabled) checkbox.checked = false;
  });

  // Submit handler: parse input -> decimal hours -> send -> update UI
  form.addEventListener("submit", e => {
    e.preventDefault();
    const subtaskId = modalSubtaskId.value;
    const parsedHours = parseTimeInputToHours(input.value);

    if (parsedHours === null) {
      alert("Invalid time format. Use like '1d 2h 30m', '2h 30m', '1:30', '90m' or '1.5h'.");
      return;
    }

    fetch(`/projects/subtask/${subtaskId}/track-time/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
      },
      body: new URLSearchParams({
        "time_tracked": String(parsedHours),
      })
    })
    .then(res => {
      if (!res.ok) throw new Error("Network response was not ok");
      return res.json();
    })
    .then(data => {
      if (!data.success) {
        alert(data.error || "Error saving time!");
        return;
      }

      // mark checkbox completed UI
      const checkbox = document.querySelector(`.toggleSubTaskCompletion[data-subtask-id="${data.subtask_id}"]`);
      if (checkbox) {
        checkbox.disabled = true;
        checkbox.checked = true;
        const titleEl = checkbox.nextElementSibling;
        if (titleEl) titleEl.classList.add("line-through", "text-gray-400");
      }

      // update sidebar values (use readable format)
      const sidebarTracked = document.getElementById("sidebarTimeTracked");
      if (sidebarTracked) sidebarTracked.textContent = formatHoursToDHM(data.time_tracked);

      const sidebarStatus = document.getElementById("sidebarStatus");
      if (sidebarStatus && String(sidebarStatus.dataset.id) === String(data.subtask_id)) {
        sidebarStatus.textContent = data.status;
      }

      // Task/Epic completion (same as before)
      if (data.task_completed) {
        const taskCheckbox = document.querySelector(`.toggleTaskCompletion[data-task-id="${data.task_id}"]`);
        if (taskCheckbox) {
          taskCheckbox.checked = true;
          taskCheckbox.disabled = true;
          const taskTitle = document.querySelector(`.task-title[data-id="${data.task_id}"]`);
          if (taskTitle) taskTitle.classList.add("line-through", "text-gray-400");
        }
        if (data.epic_completed) {
          const epicCheckbox = document.querySelector(`.toggleEpicCompletion[data-epic-id="${data.epic_id}"]`);
          if (epicCheckbox) {
            epicCheckbox.checked = true;
            epicCheckbox.disabled = true;
            const epicTitle = document.querySelector(`.epic-title[data-id="${data.epic_id}"]`);
            if (epicTitle) epicTitle.classList.add("line-through", "text-gray-400");
          }
        }
      }

      // --- NEW: update progress bar dataset + redraw + update the small text ---
      const subtaskRow = document.getElementById(`subtask-${data.subtask_id}`);
      if (subtaskRow) {
        const bar = subtaskRow.querySelector(".progress-bar-container");
        if (bar) {
          bar.dataset.tracked = data.time_tracked;
          updateSubtaskBarsForContainer(bar);
        }

        const info = subtaskRow.querySelector(".time-info");
        if (info) {
          const est = bar ? parseFloat(bar.dataset.estimated || 0) : 0;
          info.textContent = `${formatHoursToDHM(data.time_tracked)} tracked / ${formatHoursToDHM(est)} estimated`;
        }
      }

      // close modal and reset
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      input.value = "";
      if (formattedTimeDisplay) formattedTimeDisplay.textContent = "";
    })
    .catch(err => {
      console.error("❌ AJAX error:", err);
      alert("Error saving time (network).");
    });
  });
// ---------- Sidebar and other existing handlers (unchanged) ----------
const sidebar = document.getElementById("taskSidebar");
const overlay = document.getElementById("sidebarOverlay");
const closeBtn = document.getElementById("closeSidebar");

function openSidebar(data) {
  document.getElementById("sidebarTitle").textContent = data.title || "";
  document.getElementById("sidebarDescription").textContent = data.description || "";
  document.getElementById("sidebarDeadline").textContent = data.deadline || "";
  document.getElementById("sidebarPriority").textContent = data.priority || "";
  document.getElementById("sidebarStatus").textContent = data.status || "";
  document.getElementById("sidebarStatus").dataset.id = data.id || "";

  const assigned = document.getElementById("sidebarAssigned");
  if (assigned) {
    assigned.innerHTML = "";
    (data.assigned || "").split(",").forEach(user => {
      if (user.trim() !== "") {
        const span = document.createElement("span");
        span.className = "inline-block bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded-full";
        span.textContent = user.trim();
        assigned.appendChild(span);
      }
    });
  }

 // ✅ Convert hours → readable format like "1d 4h 30m"
function formatHoursToDHM(hours) {
  const totalMinutes = Math.round(hours * 60);
  const days = Math.floor(totalMinutes / (24 * 60));
  const hoursLeft = Math.floor((totalMinutes % (24 * 60)) / 60);
  const minutesLeft = totalMinutes % 60;

  const parts = [];
  if (days) parts.push(`${days}d`);
  if (hoursLeft) parts.push(`${hoursLeft}h`);
  if (minutesLeft) parts.push(`${minutesLeft}m`);
  if (parts.length === 0) parts.push("0h");
  return parts.join(" ");
}

  const sidebarTrackedElement = document.getElementById("sidebarTimeTracked");
  if (sidebarTrackedElement) {
    const tracked = parseFloat(data.time_tracked || 0);
    let trackedDisplay = "";
    if (tracked >= 24) {
      const days = Math.floor(tracked / 24);
      const hrs = Math.floor(tracked % 24);
      trackedDisplay = hrs > 0 ? `${days}d ${hrs}h` : `${days}d`;
    } else {
      trackedDisplay = `${Math.floor(tracked)}h`;
    }
    sidebarTrackedElement.textContent = trackedDisplay;
  }

  sidebar.classList.remove("translate-x-full");
  overlay.classList.remove("hidden");
}

  document.querySelectorAll(".task-title, .epic-title, .subtask-title").forEach(title => {
    title.addEventListener("click", e => {
      if (e.target.closest("input[type=checkbox]")) {
        e.preventDefault();
        return;
      }
      openSidebar(title.dataset);
    });
  });

  closeBtn.addEventListener("click", () => {
    sidebar.classList.add("translate-x-full");
    overlay.classList.add("hidden");
  });
  overlay.addEventListener("click", () => {
    sidebar.classList.add("translate-x-full");
    overlay.classList.add("hidden");
  });

  // Existing completion handlers (unchanged)...
  document.querySelectorAll(".toggleTaskCompletion").forEach(checkbox => {
    checkbox.addEventListener("change", function () {
      if (!(this.checked && !this.disabled)) { this.checked = true; return; }

      const taskId = this.dataset.taskId;
      fetch(`/projects/task/${taskId}/can-complete/`)
        .then(res => res.json())
        .then(check => {
          if (!check.allowed) {
            alert("⚠️ You can only complete this Task after all its Subtasks are completed.");
            this.checked = false;
            return;
          }
          fetch(`/projects/task/${taskId}/toggle/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
            }
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                this.disabled = true;
                const sidebarStatus = document.getElementById("sidebarStatus");
                if (sidebarStatus && String(sidebarStatus.dataset.id) === String(taskId)) {
                  sidebarStatus.textContent = "completed";
                }
                const taskTitle = document.querySelector(`.task-title[data-id="${taskId}"]`);
                if (taskTitle) taskTitle.classList.add("line-through", "text-gray-400");
              } else {
                alert(data.error || "Could not complete task");
                this.checked = false;
              }
            });
        });
    });
  });

  document.querySelectorAll(".toggleEpicCompletion").forEach(checkbox => {
    checkbox.addEventListener("change", function () {
      if (!(this.checked && !this.disabled)) { this.checked = true; return; }

      const epicId = this.dataset.epicId;
      fetch(`/projects/epic/${epicId}/can-complete/`)
        .then(res => res.json())
        .then(check => {
          if (!check.allowed) {
            alert("⚠️ You can only complete this Epic after all its Tasks are completed.");
            this.checked = false;
            return;
          }
          fetch(`/projects/epic/${epicId}/toggle/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
            }
          })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                this.disabled = true;
                const sidebarStatus = document.getElementById("sidebarStatus");
                if (sidebarStatus && String(sidebarStatus.dataset.id) === String(epicId)) {
                  sidebarStatus.textContent = "completed";
                }
                const epicTitle = document.querySelector(`.epic-title[data-id="${epicId}"]`);
                if (epicTitle) epicTitle.classList.add("line-through", "text-gray-400");
              } else {
                alert(data.error || "Could not complete epic");
                this.checked = false;
              }
            });
        });
    });
  });

}); // DOMContentLoaded
</script>


<script>
document.addEventListener("DOMContentLoaded", function () {
  // Check if URL has an anchor
  if (window.location.hash) {
    const targetId = window.location.hash.substring(1); // remove the "#"
    const targetElement = document.getElementById(targetId);

    if (targetElement) {
      // ✅ If it's a task, make sure its parent task list is visible
      if (targetId.startsWith("task-")) {
        const container = targetElement.closest(".taskListContainer");
        if (container) container.classList.remove("hidden");
      }

      // ✅ If it's a subtask, make sure parent subtask container is visible
      if (targetId.startsWith("subtask-")) {
        const subTaskContainer = targetElement.closest(".subTaskContainer");
        if (subTaskContainer) {
          subTaskContainer.classList.remove("hidden");
          // also unhide the parent task list
          const taskContainer = subTaskContainer.closest(".taskListContainer");
          if (taskContainer) taskContainer.classList.remove("hidden");
        }
      }

      // ✅ Optional: scroll into view smoothly
      targetElement.scrollIntoView({ behavior: "smooth", block: "center" });
      targetElement.classList.add("ring-2", "ring-primary"); // highlight
      setTimeout(() => targetElement.classList.remove("ring-2", "ring-primary"), 2000);
    }
  }
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  /***************************************************************************
   * Helper: format decimal hours (e.g. 25.17) -> "1d 1h 10m" or "12h" or "Today"
   ***************************************************************************/
  function formatHoursToDHM(hours) {
    const h = Number(hours) || 0;
    const totalMinutes = Math.round(h * 60);
    if (totalMinutes === 0) return "Today";

    const days = Math.floor(totalMinutes / (24 * 60));
    let rem = totalMinutes % (24 * 60);
    const hrs = Math.floor(rem / 60);
    const mins = rem % 60;

    const parts = [];
    if (days) parts.push(`${days}d`);
    if (hrs) parts.push(`${hrs}h`);
    if (mins) parts.push(`${mins}m`);
    return parts.join(" ");
  }

  /***************************************************************************
   * Core: updateSubtaskBarsForContainer(container)
   *
   * Rules:
   * - container.dataset.estimated  => hours (number)
   * - container.dataset.tracked    => hours (number)
   *
   * Visual behaviour:
   * - If estimated <= 0:
   *     - If tracked > 0 => full red (no estimate, all tracked is overdue)
   *     - else => both 0
   * - If tracked <= estimated:
   *     - green = (tracked / estimated) * 100
   *     - red = 0
   * - If tracked > estimated:
   *     - green = (estimated / tracked) * 100   // shows how much of tracked was within estimate
   *     - red   = 100 - green                    // overdue part of tracked
   *
   * NOTE: container should have overflow:hidden; fills are positioned absolute.
   ***************************************************************************/
  function updateSubtaskBarsForContainer(container) {
    if (!container) return;
    // read data attrs (strings) -> floats
    const estimated = parseFloat(container.dataset.estimated || 0);
    const tracked = parseFloat(container.dataset.tracked || 0);

    const greenFill = container.querySelector(".progress-bar-fill");
    const redFill = container.querySelector(".progress-bar-overdue");

    if (!greenFill || !redFill) return;

    // ensure consistent positioning
    container.style.position = container.style.position || "relative";
    greenFill.style.left = "0";
    greenFill.style.transform = "none";
    redFill.style.transform = "none";

    // Reset
    greenFill.style.width = "0%";
    redFill.style.width = "0%";
    redFill.style.left = "0%";

    // No estimate case
    if (!estimated || estimated <= 0) {
      if (tracked > 0) {
        // no estimate but tracked exists -> show whole bar as OVERDUE (red)
        greenFill.style.width = "0%";
        redFill.style.width = "100%";
        redFill.style.left = "0%";
      }
      // update the time-info text (use hours as 'tracked / estimated' with fallback)
      try {
        const row = container.closest("[id^='subtask-']");
        if (row) {
          const info = row.querySelector(".time-info");
          if (info) info.textContent = `${formatHoursToDHM(tracked)} tracked / ${formatHoursToDHM(estimated)} estimated`;
        }
      } catch (e) {}
      return;
    }

    // Normal cases
    if (tracked <= estimated) {
      // progress towards estimate
      const greenPercent = (tracked / estimated) * 100;
      greenFill.style.width = `${greenPercent}%`;
      redFill.style.width = "0%";
      redFill.style.left = "0%";
    } else {
      // tracked > estimated -> show composition of tracked
      const greenPercent = (estimated / tracked) * 100; // how much of tracked was within estimate
      const redPercent = Math.max(0, 100 - greenPercent); // remaining part (overdue)
      // set green from start
      greenFill.style.width = `${greenPercent}%`;
      greenFill.style.left = "0%";
      // set red starting right after green
      redFill.style.left = `${greenPercent}%`;
      redFill.style.width = `${redPercent}%`;
    }

    // update the time-info text under the bar
    try {
      const row = container.closest("[id^='subtask-']");
      if (row) {
        const info = row.querySelector(".time-info");
        if (info) {
          info.textContent = `${formatHoursToDHM(tracked)} tracked / ${formatHoursToDHM(estimated)} estimated`;
        }
      }
    } catch (e) { /* ignore */ }
  }

  // Make the function globally available so other scripts (your AJAX handlers)
  // can also call it directly (many of your handlers set dataset.tracked and call it).
  window.updateSubtaskBarsForContainer = updateSubtaskBarsForContainer;

  /***************************************************************************
   * Initialize all progress bars on page load
   ***************************************************************************/
  document.querySelectorAll(".progress-bar-container").forEach(container => {
    updateSubtaskBarsForContainer(container);
  });

  /***************************************************************************
   * (Optional) If you have AJAX code that sets `bar.dataset.tracked = ...`
   * and calls updateSubtaskBarsForContainer(bar), this will work immediately.
   *
   * Example usage in your existing fetch success block (don't duplicate):
   *
   * const subtaskRow = document.getElementById(`subtask-${data.subtask_id}`);
   * if (subtaskRow) {
   *   const bar = subtaskRow.querySelector(".progress-bar-container");
   *   if (bar) {
   *     bar.dataset.tracked = data.time_tracked;
   *     updateSubtaskBarsForContainer(bar);
   *   }
   * }
   *
   * Note: your existing code already does this — the important fix is the
   * calculation function above which correctly computes green/red composition.
   ***************************************************************************/
});
</script>



<script>
function convertToHours(timeStr) {
      // Normalize input
      timeStr = timeStr.toLowerCase().trim();

      // Extract numbers for days, hours, minutes
      const daysMatch = timeStr.match(/(\d+(?:\.\d+)?)d/);
      const hoursMatch = timeStr.match(/(\d+(?:\.\d+)?)h/);
      const minutesMatch = timeStr.match(/(\d+(?:\.\d+)?)m/);

      const days = daysMatch ? parseFloat(daysMatch[1]) : 0;
      const hours = hoursMatch ? parseFloat(hoursMatch[1]) : 0;
      const minutes = minutesMatch ? parseFloat(minutesMatch[1]) : 0;

      // Convert everything to hours
      const totalHours = (days * 24) + hours + (minutes / 60);

      return parseFloat(totalHours.toFixed(2)); // keep 2 decimal places
  }

  // Auto-convert before form submit
  const form = document.querySelector("#timeTrackForm"); // your modal form
  if (form) {
      form.addEventListener("submit", function() {
          const input = document.querySelector("#timeTrackedInput");
          if (input && input.value) {
              input.value = convertToHours(input.value);
          }
      });
  }

</script>


</body>

</html>